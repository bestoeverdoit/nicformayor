YUI.add("mail-ui-desktop-notifications-mail",function(e){function w(t){return!e.Lang.isArray(t)||t.length===0?!1:!0}function E(e){return typeof t.getVal(e,"from.name")=="undefined"||typeof t.getVal(e,"from.email")=="undefined"?!1:!0}function S(e){var t=!0,n,r;if(!w(e))return null;if(e[0].cid===undefined)return null;if(e.length===1)return!0;r=e[0].cid;for(n=1;n<e.length;n++){if(!e[n].cid)return null;if(e[n].cid!==r){t=!1;break}}return t}function x(e){var t=[],n={},r=0,i=0,o,u,a;if(!w(e))return null;o=e.length;for(u=0;u<o;u++){if(!E(e[u]))return null;a=e[u].from.name.trim()!==""?e[u].from.name:e[u].from.email;if(a.trim()==="")continue;if(s-(16+t.length*2+i+a.length+2)<0)continue;a in n?(n[a]++,r++):(n[a]=1,t.push(a),i+=a.length)}return T(e,t,r)}function T(e,n,r){var i,s,o;return n.length===0?"":n.length!==1||n.length!==e.length&&r+1!==e.length?n.length+r<e.length?(s=e.length-(n.length+r),s===1?(i=strings.str_notif_other,t.ezSub(i,{comma_separated_recipient_list:n.join(", ")})):(i=strings.str_notif_others,t.ezSub(i,{comma_separated_recipient_list:n.join(", "),num_others:String(s)}))):(i=strings.str_notif_recipients,o=n.pop(),t.ezSub(i,{comma_separated_recipient_list:n.join(", "),single_recipient:o})):(i=strings.str_notif_recipient,t.ezSub(i,{single_recipient:n[0]}))}function N(t){e.fire("openMessage",{fid:t[0].folderInfo.fid||n.getInboxFid(),isConv:0,msg:t[0]}),window.focus()}function C(){e.fire("openInbox"),window.focus()}function k(t){e.fire("openConv",{fid:t[0].fid||n.getInboxFid(),isConv:1,isThread:!0,msg:t[0]}),window.focus()}function L(t,n){e.fire("util:ymstats",{name:"notifications_click_invoke",tags:{isWinApp:NeoConfig.isWinApp,agent:m}}),NeoConfig.hasConvView?t.length>1&&!S(n)?C():k(t):t.length>1?C():N(t)}function A(e){var n;return w(e)?e.length>1?(n=strings.str_notif_new_msg,t.ezSub(n,{num_new_msgs:String(e.length)})):E(e[0])?e[0].from.name.trim()!==""?e[0].from.name:e[0].from.email:null:null}function O(t){return w(t)?t.length>1?x(t):e.common.Utils.getVal(t[0],"subject")?t[0].subject:"":null}function M(){var n=o,r,s,a=u,f,l;d&&(n=n.filter(function(e){return v.indexOf(e.msgs[0].from.email)>-1})),NeoConfig.hasConvView?r=n.reduce(function(e,t){return e.concat(t.msgs)},[]):r=n;if(!n||n.length===0)return;g=A(r),y=O(r);if(g===null||y===null)return;s=function(){o=[],L(n,r)},NeoConfig.isWinApp?r.length!==1?i=new window.Notification(g,{body:y}):(f=r[0],i=new window.Notification(g,{body:y,email:f&&f.from.email,tag:f&&f.mid,receivedDate:f&&f.receivedDate})):(t.features.enabled("mosaicNotifications")?l=_(r):l=r.length===1?D(r[0].from.email):undefined,i=h.notify(g,y,s,a,l)),e.fire("util:ymstats",{name:"notifications_notify_invoke",tags:{agent:m,isWinApp:NeoConfig.isWinApp,length:r.length}})}function _(n){var r,i,s,o;return r=n.map(function(e){return e.from.email}).filter(function(e,t,n){return n.indexOf(e)===t}),i=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/mosaic?endpoints="+r.slice(0,4).join(","),i+="&total="+r.length+"&badge=true&spsize=",o=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(o*=2),i+=o+"x"+o,s=t.settings.value("yahooMailNotificationLogo")+o+"x"+o+"_2.png",i+="&fallback_url="+s,i+="&ymreqid="+e.common.net.Session.genReqID(),i}function D(n){var r,i,s;return r=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/smtp:"+n+"/photo?format=image&badge=true&spsize=",s=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(s*=2),r+=s+"x"+s,i=t.settings.value("yahooMailNotificationLogo")+s+"x"+s+"_2.png",r+="&fallback_url="+i,r}function P(t){this.watermark=t.getMostRecentTimestamp(),t.on("MailList:modelRefresh",this.onListRefresh,this),NeoConfig.multipleAccounts&&e.on("accounts:select",function(){b&&b.detach(),b=t.once("renderComplete",function(){this.watermark=t.getMostRecentTimestamp()},this)},this)}function H(t){var n;if(!j())e.use("mail-ui-onboarding-desktop-notification",function(){n=e.mail.ui.onboarding.mailDesktopNotificationOnboard,n.init(n.calloutType.AUTO_CHECK_MAIL),f=!1});else if(!NeoConfig.isWinApp&&window.Notification.permission==="default"&&h.getSavedPreference()==="granted")h.getUserPermission(function(t){e.fire("util:ymstats",{name:"notifications_permission_"+t,tags:{agent:m}})});else{if(!w(t))return;l||(o.unshift.apply(o,t),e.mail.ui.mailDesktopNotifications.notify())}}function B(e){if(!e||typeof e.list=="undefined")return;var t=e.list.getNewMsgs(this.watermark),r=e.list.getMostRecentTimestamp();r&&n.isInboxFid(e.list.fid)&&(this.watermark=r),this.handleNotify(t)}function j(){return NeoConfig.isWinApp||!f||h.getSavedPreference()==="granted"}function F(){(new Promise(function(t){var n=r.get("importantQuery");if(n)return t(n);e.use("xobni-contacts-search-api",function(e){e.xobniContacts.searchAPI.fetch({query:"",limit:50},function(e){var n=[],r=[],i=0,s=NeoConfig.emailAddress,o,u,a;for(o=0;o<e.length&&i<20;o++){a=!1,e[o].e===s&&(a=!0);for(u=0;e[o].a_e.length>u;u++)if(e[o].a_e[u]===s){a=!0;break}!e[o].ke&&e[o].s>0&&!a&&(n=n.concat(e[o].a_e,[e[o].e]),i++)}n.length?(n.forEach(function(e){r.push("fromEmail:"+e)}),t(("("+r.join(" ")+")").replace(/\+/g,""))):t("")},function(){t("")})})})).then(function(e){v=e.split(" ").map(function(e){return e.slice(e.indexOf(":")+1)})})}function I(){c.on("blur",function(){l=!1}),p&&F(),c.on("focus",function(){l=!0,i&&!NeoConfig.isWinApp&&i.close(),o=[]}),h.currentBrowserNeedsPermission()&&(h.getUserPermission(),e.fire("util:ymstats",{name:"notifications_login_new_browser",tags:{agent:m}})),e.namespace("mail.ui").mailDesktopNotifications={isFromSameConv:S,init:P,onListRefresh:B,handleNotify:H,getRecepientList:x,openView:L,getTitle:A,getBody:O,getMosaicUrl:_,notify:M},f=!r.get(a)}var t=e.common.Utils,n=e.mail.ui.FolderUtils,r=e.mail.persist.MetaData,i=null,s=90,o=[],u="notification.mail",a="neo.pref.mailDesktopNotification.onboard",f=!1,l=!0,c=e.one("window"),h=e.mail.ui.desktopNotifications
,p=t.features.enabled("importantNotifications"),d=p&&r.get("notificationType")==="important",v=[],m=NeoConfig.browser&&NeoConfig.browser.split("_")[0],g,y,b;NeoConfig.browser.toLowerCase().indexOf("safari")!==-1&&(s=45),(h.browserSupportNotification()||NeoConfig.isWinApp)&&I()},"1.0.0",{requires:["mail-ui-desktop-notifications","cookie","common-utils","xobni-utilities","mail-ui-folder-utils","ymma-stats","mail-persist-meta-data"]});
