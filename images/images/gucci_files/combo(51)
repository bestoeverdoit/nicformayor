YUI.add("mail-api-validator",function(e){"use strict";var t=e.Lang,n={isArray:function(e,n){if(!t.isArray(n))throw new Error(e+" must be an array")},isEmpty:function(e,t){if(!t||t.length<=0)throw new Error(e+" must not be empty")},isInteger:function(e,n){if(!t.isNumber(parseFloat(n,10)))throw new Error(e+" must be a Number");n*=1;if(!t.isNumber(n)||Math.floor(n)!==n)throw new Error(e+" must be a Integer")},isEmail:function(e,t){var n=/\S+@\S+\.\S+/;if(!n.test(t))throw new Error(e+" must be a valid email address")},isString:function(e,n){if(!t.isString(n))throw new Error(e+" must be string")},oneOf:function(e,t,n){if(n.indexOf(t)<0)throw new Error(e+" value can be one of "+n.join(","))},isStringDate:function(e,n){this.isString(e,n);if(Date.parse&&!t.isNumber(Date.parse(n)))throw new Error('"'+e+'" value should be a date. e.g. Jan 4, 2014')}};e.namespace("Mail.Api"),e.Mail.Api.Validator=n},"1.0.0",{requires:[]});
YUI.add("mail-api-base-selector",function(e){"use strict";var t,n=e.mix;t=function(e){var t=this,r=e&&e.url||"",i,s=e&&e.typeName||"selector";e=e||{},i=e.mailboxId||NeoConfig.V3MailboxId,!r&&e.pathFromMailbox&&(r="/ws/v3/mailboxes/@.id=="+window.escape(i)+e.pathFromMailbox),n(t,{tagSuffix:"",typeName:s,_urlEscape:function(e){return typeof e!="string"?e:e.replace(/(\$\([a-zA-Z0-9_]+?\)|.)/g,function(e){return/^\$\([a-zA-Z0-9_]+\)$/.test(e)?e:window.encodeURIComponent(e)})},_queryStringify:function(e){var n=[],r;for(r in e)e.hasOwnProperty(r)&&n.push(t._urlEscape(r)+"="+t._urlEscape(e[r]));return n.join("&")},tag:function(e){return t.tagSuffix=e,t},serialize:function(){return r}})},e.namespace("Mail.Api").BaseSelector=t},"1.0.0",{requires:[]});
YUI.add("mail-api-yoda-response",function(e){"use strict";var t,n=e.Mail.Api.BaseSelector,r=e.common.Utils.json,i=e.mix,s="yoda-subtask-id-",o=new RegExp(s+"(.+)"),u=["httpCode","latency","query","error","taskId","progress","success","abort","status"];t=function(t){function h(e){return e*=1,e>199&&e<300}function p(){l={subTasks:[]}}function d(e){return r.tryParse(e)}function v(e){var t,n=/\/ws\/v3\/mailboxes.+?\/tasks\/\@\.id==([a-z0-9]+)/;return typeof e!="string"?undefined:(t=e.match(n),t&&t[1])}function m(e){return(new n({typeName:"tasks",pathFromMailbox:"/tasks/@.id=="+e})).tag(s+e)}function g(n,r){var i=t._batchId.parse(n),s,o,a;if(!i)return;c[i.entity]||(c[i.entity]={}),c[i.entity][i.method]||(c[i.entity][i.method]=[]),c[i.entity][i.method][i.counter]||(o={},i.iterator&&(o.tag=i.iterator),c[i.entity][i.method][i.counter]=o),a=c[i.entity][i.method][i.counter],r.result&&(s=r.result,Array.isArray(r.result)||(s=[s]),a.result?a.result=a.result.concat(s):a.result=s),e.mix(a,r,!0,u)}function y(){var e,n=t._getAllBatchIds();for(e=0;e<n.length;e++)g(n[e],{})}function b(){var e,n=t._getAllBatchIds();for(e=0;e<n.length;e++)g(n[e],{httpCode:0,abort:!0,success:!1});l.abort=!0}function w(e){var n,r=t._getAllBatchIds();for(n=0;n<r.length;n++)g(r[n],{httpCode:e,success:!1})}function E(e){var t,n=e.length;for(t=0;t<n;t++)g(e[t].id,e[t])}function S(e,t,n){var r={},i=0,s,o;for(i=0;i<e.length;i++)o=t?e[i][t]:e[i],s=n&&!t?n[o]:e[i],s&&(r[o]=s);return r}function x(e){var t={id:"",messageIds:[],total:e.length,unread:0};return e.forEach(function(e){t.id=e.conversationId,t.messageIds.push(e.id),t.unread=t.unread+(e.flags.read?0:1)}),[t]}function T(e){var t,n,r,i;if(!e.conversations){if(!e.messages)return[];n=x(e.messages)}else n=e.conversations;r=S(e.messages,"id")||[];for(i=0;i<n.length;i++)t=n[i],t.messages=S(t.messageIds,null,r);return n}function N(e,t){switch(t){case"conversations":return T(e);case"tasks":if(e.task)return[e.task];return[e];case"display":return[e];default:return e[t]}}function C(e,t,n){var r,i=c&&c[e]&&c[e][t]&&c[e][t][n];return i?(r=i.httpCode&&h(i.httpCode),t==="get"||t==="pipe"?r&&!i.error&&!!i.result:r):!1}function k(e){var t,n=e&&e.error||{};t=n.details&&n.details&&n.details.wssid||!1,t&&(l.newWssid=t)}function L(e,t){var n=e&&e.error||{};if(t===403||n.code==="EC-4008")l.relogin=!0}function A(e){var n,r=e.length,i,s,o,u;for(n=0;n<r;n++){u=e[n],i=t._batchId.parse(u.id);if(!u.response){g(u.id,{success:C(i.entity,i.method,i.counter)});continue}if(u.response.error&&u.response.error.code&&!h(u.response.error.code)){g(u.id,{error:u.response.error,success:!1});continue}if(!u.response.result){g(u.id,{success:C(i.entity,i.method,i.counter)});continue}u.response.result.query&&g(u.id,{query:u.response.result.query}),g(u.id,{result:N(u.response.result,i.entity)}),s=i.entity!=="tasks"&&(u.response.result.taskStatusUri||u.response.result.task),s?(u.response.result.taskStatusUri?o=v(u.response.result.taskStatusUri):o=u.response.result.task.id,l.subTasks.push(m(o)),g(u.id,{progress:0,taskId:o,status:"PENDING",success:!1})):g(u.id,{progress:100,taskId:0,status:"COMPLETED",success:C(i.entity,i.method,i.counter)})}}function O(e,n){var r=e.id||e.taskId;t._eachResponses(function(t,i,s,o){o.taskId===r&&(o.progress=e.progress,o.status=e.status,e.status==="COMPLETED"?o.success=!0:o.error={code:"task-failed-"+e.status,message:"ymreqid of subtask is "+n})})}function M(e){t._eachResponses(function(t,n,r,i){i.taskId===e&&(i.error={code:"task-exception"})})}function _(){t._eachResponses(function(e,t,n,r){var i=r&&r.error&&r.error.code,s=i&&r.error.message,o=r.httpCode!==undefined&&"HTTP-"+r.httpCode,u=i||r.httpCode||"unknown",a=i||o||"unknown";t==="remove"&&i==="EC-4007"&&(r.success=!0),r.success===undefined&&(r.success=r.httpCode>199&&r.httpCode<300),r.success===!1?(r.yodaErrorCode=e+"-"+t+"-"+a,r.taeMapCode=u,r.errorMessage=s):(r.yodaErrorCode="",r.taeMapCode="",r.errorMessage="")})}var a=this,f=t._logger,l={subTasks:[]},c={_debug:[]};i(a,{_initResponse:y,parse:function(e){var t=d(e.response||e.responseText),n;return p(),c._debug.push(e),c.yodaErrorCode="",e.statusText==="abort"?(b(),l):e.status===0?(w(0),c.yodaErrorCode="connectionFailure",f.error.connectionFailure(c.yodaErrorCode),l):h(e.status)?e.response===""||!t||!t.result||!t.result.status?(w(e.status),c.yodaErrorCode="invalidBatchResponseFormat-HTTP-"+e.status,f.error.invalidBatchResponseFormat(e.status,c.yodaErrorCode),l):(t.result.status.failedRequests&&E(t.result.status.failedRequests),t.result.status.successRequests&&E(t.result.status.successRequests),t.result.responses&&A(t.result.responses),_(),l):(w(e.status),k(t),L(t,e.status),!l.newWssid&&!l.relogin&&(n=t&&t.error||{code:"",message:""},c.yodaErrorCode="batchRequestFailed-"+(n.code||"HTTP-"+e.status),f.error.batchRequestFailed(n,e.status,c.yodaErrorCode)),l)},parseSubTaskResponse:function(e){var t,n;return p(),e&&e.tasks&&e.tasks.get?(t=e.tasks.get,Array.isArray(t)?(t.forEach(function(t){var r;t.success?(r=t.result[0],O(r,e._ymreqid),(r.status==="IN_PROGRESS"||r.status==="PENDING")&&l.subTasks.push(m(r.id||r.taskId))):(n=t.tag.match(o),n&&M(n[1]))}),_(),l):l):l},parseAsAbort:function(){return p(),b(),_(),l},serialize:function(){return c._ymreqid=t._IO._getYmreqid(),c}})},e.namespace("Mail.Api").YodaResponse=t},"1.0.0",{requires:["mail-api-base-selector","common-utils-jsonparse"]});
YUI.add("mail-api-utility",function(e){"use strict";function t(e,n){var i=Array.isArray(e)?[]:{};return e?n<=0?".":typeof e!="object"?e:(r(e,function(r){i[r]=t(e[r],n-1)}),i):null}function n(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-api-utility:1",t,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-api-utility:1"),null}}function r(e,t){(typeof e=="object"?Object.keys(e):[]).forEach(function(n){t(n,e[n])})}function i(e,t){var n=[];return t||(t="root"),e===null||e===undefined?[]:typeof e!="object"?[{key:t,depth:t.split(".").length-1,size:JSON.stringify(e).length}]:(r(e,function(r){n=n.concat(i(e[r],t+"."+r))}),n)}function s(e,t,n){var r=t.split("."),i=r.length-1,s=e;r.forEach(function(e,t){if(t===0)return;if(s===undefined||s===null)return;if(t===i){s[e]=n;return}s=s[e]})}function o(e,t){var n=t.split("."),r=null,i=n.length-1,s=e;return n.forEach(function(e,t){if(t===0)return;if(s===undefined||s===null)return;t===i&&(r=s[e]),s=s[e]}),r}function u(e){var t,n=new Array(256),r,i=-1,s=0,o=e.length,u,a;for(a=0;a!==256;++a)t=a,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,t=t&1?-306674912^t>>>1:t>>>1,n[a]=t;n=typeof Int32Array!="undefined"?new Int32Array(n):n;for(s=0;s<o;)t=e.charCodeAt(s++),t<128?i=i>>>8^n[(i^t)&255]:t<2048?(i=i>>>8^n[(i^(192|t>>6&31))&255],i=i>>>8^n[(i^(128|t&63))&255]):t>=55296&&t<57344?(t=(t&1023)+64,u=e.charCodeAt(s++)&1023,i=i>>>8^n[(i^(240|t>>8&7))&255],i=i>>>8^n[(i^(128|t>>2&63))&255],i=i>>>8^n[(i^(128|u>>6&15|t&3))&255],i=i>>>8^n[(i^(128|u&63))&255]):(i=i>>>8^n[(i^(224|t>>12&15))&255],i=i>>>8^n[(i^(128|t>>6&63))&255],i=i>>>8^n[(i^(128|t&63))&255]);return r=i^-1,r=(new window.Uint32Array([r]))[0].toString(16),r}function a(e,t){var n,r,u,a,f,l,c,h=JSON.stringify(e).length;if(t>=h)return h;r=i(e),r=r.sort(function(e,t){return e.depth===t.depth?t.size-e.size:t.depth-e.depth}),u=r.length;for(n=0;n<u;n++){a=h-t,f=o(e,r[n].key),l=typeof f=="string",c=l?0:2;if(a<=0)break;if(a+5<r[n].size){f=(""+f).substr(0,r[n].size-(a+5))+"...",s(e,r[n].key,f);break}s(e,r[n].key,"."),h-=JSON.stringify(f).length-3}return h}e.namespace("mail.api").utility={trimObjectLeaves:a,getShallowObject:t,getObjectLeaves:i,getObjectVal:o,setObjectVal:s,JSONClone:n,crc32:u,eachKeys:r}},"1.0.0",{requires:[]});
YUI.add("mail-api-yoda-logger",function(e){"use strict";var t,n=0,r=e.mail.api.utility,i=e.mix,s=e.common.Utils.json,o=5120,u=["ES-2001"],a="debug_yoda";t=function(t,f){function d(n){var r=n||{},i=t.serialize(),s,o=t._IO&&t._IO._getYmreqid()||"",u=b();w(r,i,u,o),e.mail.Error&&e.mail.Error.handleV3&&(s={code:n.taeMapCode,message:n.message,resource:t.getTitle(),request:{urlparams:{ymreqid:o}},status:"",statusText:"",suppressStat:!f.statTAE,suppressNotification:!f.showTAE},e.mail.Error.handleV3([s])),g("io_failed")}function v(e){h.push(e)}function m(){h.forEach(function(e){var t=e.code==="connectionFailure",r=Math.floor(Date.now()/1e3),i=r-n;if(i<10&&t)return;t&&(n=r),d(e)}),h=[]}function g(t){e.fire("util:ymstats",{name:a+"_"+t,include:{farm:!0}})}function y(t,n,r){e.fire("stat:feature_latency",{feature_group:"yoda_"+t,message:n,value:r})}function b(){var e,n,r=t.getResponse(),i,o,u=[];if(!r._debug)return"";n=r._debug.length;for(e=0;e<n;e++)o=r._debug[e].response||r._debug[e].responseText,i=s.tryParse(o),i===null&&(i=o),u.push(i);return u}function w(t,n,i,s){var u,f,l=NeoConfig.isCorpmail?"critical":"info";u={code:t.code,message:t.message,farm:NeoConfig.farm},f=r.JSONClone({request:n,response:i,ymreqid:s}),f.response=r.getShallowObject(f.response,8),f.request=r.getShallowObject(f.request,8),r.trimObjectLeaves(f.response,o),r.trimObjectLeaves(f.request,o),u.ioInfo=f,NeoConfig.mailEnv==="dev"?console.log(a+"====>>>",u):e.fire("SplunkLog","debug_yoda",u,l)}function E(){if(p)return;t._eachResponses(function(e,t,n,r){var i,s="Individual request failed with ";if(r.abort)return;if(r.error&&u.indexOf(r.error.code)>=0)return;if(r.success!==!1)return;r.errorMessage?s="message "+r.errorMessage:s="code "+r.yodaErrorCode,i={code:r.yodaErrorCode,taeMapCode:r.taeMapCode||r.yodaErrorCode,message:s},v(i)})}function S(e){return e===429||e===999?"999":"400"}var l=this,c,h=[],p=!1;f=f||{},i(l,{discardQueuedErrorInfo:function(){h=[]},statRetry:function(t){e.fire("SplunkLog","debug_yoda_retry",t,"critical")},lifeCycle:{instantiated:function(){g("instantiated")},syncStart:function(){c=Date.now(),g("sync_start")},syncResolve:function(){g("sync_resolve"),y("sync_resolve","overall",Date.now()-c),E(),m()}},error:{connectionFailure:function(e){var t={code:e,taeMapCode:"conn",message:"No internet Access"};p=!0,v(t)},batchRequestFailed:function(e,t,n){var r={code:n,taeMapCode:S(t),message:"batch returned non-2xx. "+e.message};p=!0,v(r)},invalidBatchResponseFormat:function(e,t){var n={code:t,taeMapCode:S(e),message:"batch response was not as expected"};p=!0,v(n)}}})},e.namespace("Mail.Api").YodaLogger=t},"1.0.0",{requires:["mail-api-utility","common-utils-jsonparse"]});
YUI.add("mail-api-batch-id-helper",function(e){"use strict";var t,n=e.mix,r="yoda";t=function(){function t(t){var n=0;return e[t]||(e[t]=0),n=e[t],e[t]=e[t]+1,n}var e={};return n(this,{parse:function(e){var t;return e?(t=e.split("."),t.length<4?null:t[0]!==r?null:{entity:t[1],method:t[2],counter:t[3],requestIndex:t[4],iterator:t[5]}):null},getCounter:function(e){var n=[r,e.method,e.entity].join("_");return t(n)},generate:function(e){var t=e.method,n=e.entity,i=e.counter,s=e.requestIndex,o=e.iterator,u=[r,n,t];return i||(i=this.getCounter(e)),u.push(i),s!==undefined?u.push(s):o&&u.push(0),o&&u.push(o),u.join(".")}})},e.namespace("Mail.Api").BatchIdHelper=t},"1.0.0",{requires:["mail-api-validator"]});
YUI.add("mail-api-yoda-io",function(e){"use strict";var t,n=e.QueryString,r=e.common.net.Session,i=e.common.Utils,s=e.mix,o=i.settings.value("yodaStatusCheckFreq",4e3),u=i.settings.value("yodaRetryErrorMap",[]),a=200,f=3e4,l=1,c=2;t=function(t,h){function L(e){if(typeof e!="function")throw new Error("scheduleNextCall Failed: fn is invalid");if(k)throw new Error("scheduleNextCall Failed: subTaskScheduleTimer is not null");m>=S.maxCount?(t._eachResponses(function(e,t,n,r){r.status!=="COMPLETED"&&(r.error={code:"task-check-limit-exceeded"})}),q()):(k=setTimeout(e,m===0?0:S.checkFeq),m++)}function A(){var e="/ws/v3/batch?",r={yoda_batch:t.getHash(),ymreqid:T,appid:w,wssid:b};return e+n.stringify(r)}function O(e){var t=JSON.parse(JSON.stringify(e)),n;for(n in e){if(!e.hasOwnProperty(n)||typeof e[n]!="function")continue;t[n]=e[n]}return t}function M(){if(!C)throw new Error("Trying to resolve sync. after it is canceled.");C.resolve(t._response.serialize()),d.lifeCycle.syncResolve(),y=null,C=null,T="",v=null,x=h.maxRetry||c}function _(t){var n=e.common.UserSession.getState();t&&(g>=l&&M(),n.newuser?e.common.net.Error.reloadUserChange():(b=t,g++,e.common.net.Error.setWssid(t),C.io=F()))}function D(){e.once("net:reloginSuccessful",function(){C.io=F()}),e.common.net.Error.simpleRelogin()}function P(){var e=t.getResponse(),n={type:null,yodaErrorCode:e&&e.yodaErrorCode,numberOfRequest:0};return n.yodaErrorCode?n.type="batchLevel":(t._eachResponses(function(e,t,r,i){n.yodaErrorCode||(n.yodaErrorCode=i&&i.yodaErrorCode),n.numberOfRequest++}),n.yodaErrorCode&&(n.type="requestLevel")),n}function H(){var e=!1,t=P();return y&&(t.yodaErrorCode?d.statRetry({code:y,success:!1,attempt:c-x}):d.statRetry({code:y,success:!0,attempt:c-x})),u.length<=0||x<=0||!t.yodaErrorCode?!1:t.type==="requestLevel"&&t.numberOfRequest>1?!1:(u.forEach(function(n){if(e)return;t.yodaErrorCode===n&&(e=!0)}),e&&(y=t.yodaErrorCode),e)}function B(n){var i,s=O(h);s.showTAE=!1,n&&n.length>0?(i=new e.Mail.Api.Yoda(s),v=new e.Mail.Api.Yoda(s),n.forEach(function(e){i.tasks.get(e),v.tasks.remove(e)}),L(function(){i.sync().then(function(e){var n=t._response.parseSubTaskResponse(e),r=n.subTasks;t._emitChange();if(!C)return;k=null,B(r)})})):H()?(d.discardQueuedErrorInfo(),T=r.genReqID(),C.io=F()):M()}function j(e,n){var r=t._response.parse(n);if(r.abort)return;if(r.newWssid){_(r.newWssid);return}if(r.relogin){D();return}B(r.subTasks)}function F(){var e;x-=1;if(x>=0)return e=I(j),N({URL:A(),method:"POST",onDataRecieved:e,data:{responseType:"json",requests:t.serialize()}});M()}function I(e){var t=!1;return function(){if(t)return;t=!0,e.apply(this,arguments)}}function q(){if(!C)return;k&&clearTimeout(k),C.io&&C.io.abort(),v&&v.sync(),M()}var p=this,d=t._logger,v=null,m=0,g=0,y=null,b,w,E,S,x,T,N,C,k;b=h.wssid||NeoConfig.wssid,w=h.appid||i.settings.value("appid"),E=h.timeout||f,h.asyncAPI?(S={},S.checkFeq=h.asyncAPI.checkFeq||o,S.maxCount=h.asyncAPI.maxCount||a):S={checkFeq:o,maxCount:a},x=h.maxRetry||c,N=function(t){return e.io(t.URL,{timeout:E,method:t.method,data:t.data&&JSON.stringify(t.data),headers:{"Content-Type":"application/json",accept:"application/json"},on:{complete:t.onDataRecieved,failure:t.onDataRecieved}})},h._makeXHR&&(N=h._makeXHR),s(p,{_getYmreqid:function(){return T},sync:function(){var e;m=0,t._response._initResponse(),d.lifeCycle.syncStart();if(C)throw new Error("Can not start another sync. previous sync is in progress");return T=r.genReqID(),e=F(),new Promise(function(t,n){C={resolve:t,reject:n,io:e}})},cancel:function(){if(!C)return;k&&clearTimeout(k),C.io&&C.io.abort(),v&&v.sync(),t._response.parseAsAbort(),M()}})},e.namespace("Mail.Api").YodaIO=t},"1.0.0",{requires:["io","common-net-sessionmgr","querystring-stringify-simple","mail-common-utils-settings"]});
YUI.add("mail-api-batch",function(e){"use strict";var t,n=e.mix;t=function(e){var t,r,i;e=e||{},r=e.id,i=e.uri||e.url;if(!r)throw new Error("id is required");if(!i)throw new Error("uri is required");return t={id:r,uri:i,method:"GET"},n(this,{postJSON:function(e){return t.method="POST",t.payloadType="embedded",t.payload=e,delete t.payloadParts,delete t.payloadString,this},postString:function(e){return t.method="POST",t.payloadType="embedded",t.payloadString=e,delete t.payload,delete t.payloadParts,this},postMultipart:function(e){return t.method="POST",t.payloadType="multipart",t.payloadParts=e,delete t.payload,delete t.payloadString,this},deleteOp:function(){return t.method="DELETE",this},select:function(e){return t.filters=e.serialize(),this},suppressResponse:function(e){return e=e||!0,t.filters||(t.filters={}),t.filters.suppressResponse=!0,this},then:function(e){return t.requests?t.requests.push(e.serialize()):t.requests=[e.serialize()],this},serialize:function(){return t},getId:function(){return t.id}})},e.namespace("Mail.Api").Batch=t},"1.0.0",{requires:["mail-api-validator"]});
YUI.add("mail-api-base-entity",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.Batch;t=function(e){function o(e,t){return s._batchId.generate({method:e,entity:i,iterator:t&&t.tagSuffix})}var t=this,i=e.baseName,s=e.yoda;return n(t,{get:function(e){if(e.typeName!==i)throw new Error("selector type mismatch");return s.addBatch(new r({uri:e.serialize(),id:o("get",e)})),s},update:function(e){var t,n;t=e.serialize();if(e.typeName!==i)throw new Error("updator type mismatch");return n=(new r({uri:t.url,id:o("update",e)})).postJSON(t.postPayload),s.addBatch(n),s},create:function(e){if(e.typeName!==i)throw new Error("creator type mismatch");return s},remove:function(e){if(e.typeName!==i)throw new Error("selector type mismatch");return s.addBatch((new r({uri:e.serialize(),id:o("remove",e)})).deleteOp()),s},pipe:function(e,t){var n,u;if(e.typeName!==i)throw"selector type mismatch";if(t&&t.typeName!==i)throw"iterator type mismatch";u=e.serialize();if(typeof u=="string")n=new r({uri:u,id:o("pipe",e)});else{if(!u.url)throw"can not pipe operator without url";n=new r({uri:u.url,id:o("pipe",e)}),u.postPayload&&n.postJSON(u.postPayload)}return t&&n.select(t),s.openPipe(n),s}})},e.namespace("Mail.Api").BaseEntity=t},"1.0.0",{requires:["mail-api-validator","mail-api-batch"]});
YUI.add("mail-api-display-entity",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.Batch;t=function(e){function o(e,t){return s._batchId.generate({method:e,entity:i,iterator:t&&t.tagSuffix})}var t=this,i="display",s=e.yoda;return n(t,{get:function(e){var t,n;if(e.typeName!==i)throw new Error("selector type mismatch");return t=e.serialize(),n=(new r({uri:t.url,id:o("get",e)})).postJSON(t.postPayload),s.addBatch(n),s}})},e.namespace("Mail.Api").DisplayEntity=t},"1.0.0",{requires:["mail-api-validator","mail-api-batch"]});
YUI.add("mail-api-yoda",function(e){"use strict";var t,n=e.Mail.Api.Batch,r=e.Mail.Api.YodaResponse,i=e.mail.api.utility,s=e.mix,o=e.Mail.Api.YodaLogger,u=e.Mail.Api.BatchIdHelper,a=e.Mail.Api.YodaIO,f=e.Mail.Api.DisplayEntity,l=e.Mail.Api.BaseEntity;t=function(e){function m(){return c[c.length-1]}function g(e){return new l({yoda:t,baseName:e})}var t=this,c=[],h=[],p,d=[],v=[];e=e||{},e.statTAE=e.statTAE===!1?!1:!0,e.showTAE=e.showTAE===!1?!1:!0,t._batchId=new u,t.actionTitle=e.actionTitle,p=t._logger=new o(t,e),t._response=new r(t),t._IO=new a(t,e),p.lifeCycle.instantiated(),s(t,{mailboxes:g("mailboxes"),accounts:g("accounts"),folders:g("folders"),messages:g("messages"),conversations:g("conversations"),tasks:g("tasks"),display:new f({yoda:t}),addBatch:function(e){return h.push(e.getId()),Array.isArray(v)?v.push(e):v instanceof n&&v.then(e),t},openPipe:function(e){return t.addBatch(e),c.push(v),v=e,t},closePipe:function(){return m()?(v=c.pop(),t):t},closeAllPipe:function(){while(m())t.closePipe();return t},sync:function(){return t._IO.sync()},serialize:function(){var e=[],t,n;if(m())throw new Error("yoda has unclosed pipes.");for(n=0;n<v.length;n++)t=v[n].serialize(),e.push(t);return e},getHash:function(){var e=this._getAllBatchIds(),t="";return t=e.length>1?"multi":e.join(""),t+"-"+i.crc32(JSON.stringify(this.serialize()))},_getAllBatchIds:function(){return h},_hasBatchId:function(e,n,r){var i=t._getAllBatchIds();return i.some(function(i){var s=t._batchId.parse(i);return s.entity===e||s.method===n||s.index===r})},_eachResponses:function(e){var n=t.getResponse();i.eachKeys(n,function(n,r){i.eachKeys(r,function(r,i){if(!i.forEach||!t._hasBatchId(n,r,0))return;i.forEach(function(i,s){if(!t._hasBatchId(n,r,s))return;e(n,r,s,i)})})})},getResponse:function(){return t._response.serialize()},cancelSync:function(){return t._IO.cancel(),t},onChange:function(e){if(typeof e!="function")return;return d.push(e),t},detachChangeListener:function(e){return d.splice(d.indexOf(e),1),t},hasItemToSync:function(){return v.length>0?!0:!1},_emitChange:function(){d.forEach(function(e){try{e.apply(null,[t.getResponse(),t])}catch(n){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-api-yoda:1",n,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-api-yoda:1")}})},getTitle:function(){return t.actionTitle?"yoda_"+t.actionTitle:"yoda"}})},e.namespace("Mail.Api").Yoda=t},"1.0.0",{requires:["mail-api-validator","mail-api-yoda-response","mail-api-yoda-logger","mail-api-batch-id-helper","mail-api-yoda-io","mail-api-batch","mail-api-base-entity","mail-api-display-entity"]});
YUI.add("mail-api-message-selector",function(e){"use strict";var t,n=e.Mail.Api.BaseSelector,r=e.Mail.Api.Validator,i=e.mix,s=e.Lang,o=["image","attachment"],u=["attachment","read","unread","flagged","starred"],a=["TRASH","DRAFT","SENT","INBOX","BULK","USER","SYNC","INVISIBLE","ARCHIVE"],f=["date","subject","sender","relevance","to","recipient","attachment","flagged","unread"],l=["personal","financial","social","travel"];t=function(n){function y(e,t){g[e]=t}function b(e,t){var n=[];g[e]?(s.isArray(g[e])?n=g[e]:n.push(g[e]),n.push(t),y(e,n)):y(e,t)}function w(e){if(g.has)throw new Error("has is already set to "+g.has);r.oneOf("has",e,o),y("has",e)}function E(){y("timezone",m)}function S(){var t=[];return e.Object.each(g,function(n,r){e.Lang.isArray(n)?e.Array.each(n,function(e){t.push(r+":"+e)}):t.push(r+":"+n)}),t.join(" ")}function x(){var e,t=["groupBy","timezone","sort","is"],n=["in","folderId"],r=!1;for(e in g){if(!g.hasOwnProperty(e)||t.indexOf(e)>=0)continue;if(n.indexOf(e)>=0){r=!0;continue}return!1}return r}var c=this,h=!1,p=!1,d="",v,m,g;n=n||{},v=n.mailboxId||NeoConfig.V3MailboxId,m=n.timeZone||NeoConfig.clientTimeZone,g={},i(c,{typeName:"messages",_isQueryFulfilled:function(){var e=!1,t=["groupBy","timezone","sort","acctId"],n;for(n in g)if(g.hasOwnProperty(n)&&g[n]!==null&&t.indexOf(n)===-1){e=!0;break}return h?!0:e},id:function(t){var n;return r.isArray("mids",t),r.isEmpty("mids",t),t=e.Array.dedupe(t),n=e.Array.map(t,function(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}).join(" "),y("id","("+n+")"),c},conversationId:function(t){return c.typeName="conversations",r.isArray("conversationId",t),r.isEmpty("conversationId",t),t=e.Array.dedupe(t),y("conversationId","("+t.join(" ")+")"),c},folderId:function(e){return y("folderId",e),c},folderType:function(e){return r.oneOf("folderType",e,a),b("folderType",e),c},notFolderType:function(e){return r.oneOf("notFolderType",e,a),b("-folderType",e),c},acctId:function(e){return y("acctId",e),c},isRead:function(){return y("is","read"),c},isUnread:function(){return y("is","unread"),c},isStarred:function(){return y("is","flagged"),c},inInbox:function(){return y("in","Inbox"),c},inArchive:function(){return y("in","Archive"),c},inDraft:function(){return y("in","Draft"),c},inSent:function(){return y("in","Sent"),c},queryToken:function(e){return r.isString("queryToken",e),y("queryToken",e),c},hasImage:function(){return w("image"),c},hasAttachment:function(){return w("attachment"),c},mail:{category:function(e){return r.oneOf("category",e,l),y("category",e),c},size:function(e){return r.isInteger("size",e),y("size",e*1),c},subject:function(e){return r.isString("subject",e),y("subject",e),c},body:function(e){return r.isString("body",e),y("body",e),c},attachmentCount:function(e){return r.isInteger("attachmentCount",e),y("attachmentCount",e*1),c},attachmentType:function(e){return y("attachmentType",e),c},content:function(e){return y("content",e),c}},userQuery:function(e){return y("userQuery",e),c},person:{fromName:function(e){return r.isString("from",e),y("from",e),c},toName:function(e){return r.isString("to",e),y("to",e),c},ccName:function(e){return r.isString("cc",e),y("cc",e),c},toEmail:function(e){return r.isEmail("toEmail",e),y("toEmail",e),c},fromEmail:function(e){return r.isEmail("fromEmail",e),y("fromEmail",e),c}},time:{on:function(e){return r.isString("on",e),r.isStringDate("on",e),E(),y("on",e),c},after:function(e){return r.isString("after",e),r.isStringDate("after",e),E(),y("after",e),c},before:function(e){return r.isString("before",e),r.isStringDate("before",e),E(),y("before",e),c},year:function(e){return r.isInteger("year",e),y("year",e*1),E(),c},month:function(e){return r.isInteger("month",e),y("month",e*1),E(),c},day:function(e){return r.isInteger("day",e),y("day",e*1),E(),c}},page:{count:function(e){return r.isInteger("count",e),y("count",e*1),c},offset:function(e){return r.isInteger("offset",e),y("offset",e*1),c},sortBy:function(e){var t=e;r.isString("sortBy",e);if(e[0]==="+"||e[0]==="-")t=t.substr(1);return r.oneOf("sortBy",t,f),y("sort","("+e+")"),c}},includeSoftDeleted:function(){return y("include","softdeleted"),c},groupBy:function(e){return r.oneOf("groupBy",e,u),y("groupBy",e),c},groupByConversation:function(){return p=!0,this.typeName="conversations",y("groupBy","conversationId"),c},raw:function(e){return r.isString("raw",e),h=!0,d=e,c},isBulkOperation:function(){return typeof n.isBulkOperation!="undefined"?n.isBulkOperation:x()},serialize:function(){var e="/ws/v3/mailboxes/@.id=="+c._urlEscape(v)+"/messages/@.select==q",t={q:h?d:S()};return c.isBulkOperation()&&(t.async="true"),e+"?"+c._queryStringify(t)}}),t.superclass.constructor.call(this,n)},e.extend(t,n),e.namespace("Mail.Api").MessageSelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-api-display-selector",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.BaseSelector;t=function(r){var i=this,s,o,u,a;r=r||{},s=r.wssid||NeoConfig.wssid,u=r.messageId,o=r.mailboxId||NeoConfig.V3MailboxId,a={method:"GetDisplayMessage",params:[{fid:"Inbox",enableRetry:!0,textToHtml:!0,urlDetection:!0,emailDetection:!0,qtAnnotate:{enable:!0},emailComposeUrl:"mailto:%e%",truncateAt:1e5,charsetHint:"",annotateOption:{annotateText:"inline"},message:[{blockImages:"none",restrictCSS:!0,expandCIDReferences:!0,enableWarnings:!0,mid:u}]}]};if(!u)throw new Error("messageId is required");n(i,{typeName:"display",blockImages:function(e){return a.params[0].message[0].blockImages=e,i},showFull:function(){return delete a.params[0].truncateAt,i},setFid:function(e){return a.params[0].fid=e,i},setCharsetHint:function(e){return a.params[0].charsetHint=e,i},setFilter:function(t){return t&&(e.mix(a.params[0],t,!0),t.midRequest&&(e.mix(a.params[0].message[0],t.midRequest,!0),a.params[0].midRequest=null)),i},serialize:function(){var e="/ws/mail/v2.0/jsonrpc";return{url:e,postPayload:a}}}),t.superclass.constructor.call(this,r)},e.extend(t,r),e.namespace("Mail.Api").DisplaySelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-api-message-updater",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.Validator,i=e.Mail.Api.MessageSelector,s="messages";t=function(t){function c(t){var n=e.mail.Controller.ImapIn,r=e.mail.ui.FolderUtils;switch(t){case"spam":return n.getFolderByType(r.SpamFolderType,u);case"ham":return n.getFolderByType(r.InboxFolderType,u)}return{id:"invalidFolderId"}}function h(e,t){l.message.flags||(l.message.flags={}),l.message.flags[e]=t}function p(e){l.message.folder||(l.message.folder={}),l.message.folder.id=e}var o=this,u,a,f=NeoConfig&&NeoConfig.accounts&&NeoConfig.accounts.primaryAccount&&NeoConfig.accounts.primaryAccount[0].id||"",l;t=t||{},a=t.messageSelector,u=t.accountId||f;if(!(a instanceof i))throw new Error("messageSelector must be of type MessageSelector");l={message:{}},n(o,{typeName:s,read:function(){return h("read",!0),o},unread:function(){return h("read",!1),o},star:function(){return h("flagged",!0),o},unstar:function(){return h("flagged",!1),o},move:function(e){return r.isInteger("folderId",e),p(e),o},spam:function(){var e=c("spam");return h("spam",!0),p(e.id),o},ham:function(){var e=c("ham");return h("ham",!0),p(e.id),o},forwarded:function(){return h("forwarded",!0),o},answered:function(){return h("answered",!0),o},notmymail:function(){return h("notmymail",!0),o},phished:function(){return h("phished",!0),o},sendercompromised:function(){return h("sendercompromised",!0),o},serialize:function(e){if(!a._isQueryFulfilled())throw new Error("messageSelector should have fulfilled query for update operation");return this.typeName=a.typeName,this.tagSuffix=a.tagSuffix,{url:a.serialize(e),postPayload:l}}}),this.tagSuffix=a.tagSuffix,this.typeName=a.typeName},e.namespace("Mail.Api").MessageUpdater=t},"1.0.0",{requires:["mail-api-message-selector","mail-api-validator","mail-controller-imapin","mail-ui-folder-utils"]});
YUI.add("mail-controller-v3-helper",function(e){var t=e.Lang,n=e.mail.ui.FolderUtils,r=e.mail.model.DataStore.Messages,i=e.mail.Controller.ImapIn,s="yoda_cntlr",o;o={FLAGS:{replied:"isReplied",flagged:"isFlagged",read:"isRead",draft:"isDraft",forwarded:"isForwarded",ham:"isHam",spam:"isSpam",notmymail:"notmymail"},nextTick:function(e,t){var n=setTimeout(e,1);return{abort:function(){clearTimeout(n),typeof t=="function"&&t()}}},pluck:function(n,r){return t.isArray(n)||(n=[n]),e.Array.map(n,function(e){return e[r]||e})},dedupe:function(e,n,r){var i={},s,o;t.isArray(e)||(e=[e]);for(o=e.length-1;o>=0;o--){s=e[o];if(!s||!s[n])continue;i[s[n]]?e.splice(o,1):(r&&r(s),i[s[n]]=!0)}return e},createYodaSyncDebouncer:function(e){var t={},n=function(){var n=Date.now(),r;for(r in t){if(!t.hasOwnProperty(r))return;n-t[r].time>e&&delete t[r]}};return function(r){var i=Date.now(),s,o;return n(),o=t[r.getHash()],o?o.promise:(s=r.sync(),t[r.getHash()]={promise:s,time:i},s)}},getFlagStatusForDS:function(e){var t=o.FLAGS,n={},r;for(r in e)t[r]&&(n[t[r]]=e[r]);return n[t.spam]?n[t.ham]=0:n[t.ham]&&(n[t.spam]=0),n},setFlagInUpdater:function(t,n){return e.Object.each(t,function(e,t){switch(t){case"flagged":e===1?n.star():n.unstar();break;case"read":e===1?n.read():n.unread();break;case"sendercompromised":case"notmymail":case"phished":case"spam":e===1&&n.spam();break;case"ham":e===1&&n.ham();break;case"forwarded":e===1&&n.forwarded();break;case"replied":e===1&&n.answered()}}),n},updateUnreadCountForDestOnMove:function(e,t){var n=0,r,i,s;for(r=0;r<t.length;r++)i=t[r],s=i.flags&&i.flags.isRead,n+=s?0:1;e.unread=e.unread+n},getFolderId:function(t){var n=e.mail.model.DataStore.Folders.getByFid(t);return n?n.id:null},setFolderSelection:function(e,t,r){var s=i.getCurrentAccount().id,u=n.getFolderTypeByFid(t),a;switch(u){case n.DraftFolderType:r==="delete"?a=o.getFolderId(n.getDraftFid(s)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType));break;case n.SentFolderType:r==="move"||r==="delete"?a=o.getFolderId(n.getSentFid(s)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType));break;case n.SpamFolderType:if(r==="delete"||r==="flag")a=o.getFolderId(n.getSpamFid(s));break;case n.TrashFolderType:if(r==="delete"||r==="flag")a=o.getFolderId(n.getTrashFid(s));break;default:r==="move"||r==="delete"?(e.notFolderType(n.SentFolderType),e.notFolderType(n.DraftFolderType)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType))}a&&e.folderId(a)},isDestinationForMoveValid:function(t,r){var i=n.getFolderTypeByFid(t),s=r&&n.getFolderTypeByFid(r),o;switch(i){case n.DraftFolderType:s&&(o="move from DRAFT not allowed");break;case n.SentFolderType:s===n.DraftFolderType&&(o="cannot move message to DRAFT");break;default:if(s===n.DraftFolderType||s===n.SentFolderType)o="cannot move message to DRAFT or SENT"}return o?(e.use("common-utils-error",function(){e.common.Utils.error.report(o,1,1,1)}),!1):!0},setSpamHamForMove:function(e,t,r){var i=n.getFolderTypeByFid(t),s=r&&n.getFolderTypeByFid(r),u=o.FLAGS,a={};switch(i){case n.DraftFolderType:break;case n.SpamFolderType:s!==n.SpamFolderType&&s!==n.TrashFolderType&&(e&&e.ham(),a[u.spam]=0,a[u.ham]=1);break;default:s===n.SpamFolderType&&(e&&e.spam(),a[u.spam]=1,a[u.ham]=0)}return a},getFilteredMarkMails:function(e,n){var r=o.FLAGS,i,s,u,a;t.isArray(e)||(e=[e]),i=e.length;for(a=e.length-1;a>=0;a--)if(e[a].flags){if(typeof n.flagged!="undefined"&&e[a].flags[r.flagged]===n.flagged){e.splice(a,1);continue}typeof n.read!="undefined"&&e[a].flags[r.read]===n.read&&e.splice(a,1)}return e.length!==i&&(typeof n.flagged!="undefined"?s=n.flagged?"flag":"unflag":typeof n.read!="undefined"&&(s=n.read?"read":"unread"),u={message:"flagselection",total:i,filtered:i-e.length,op:s},o.splunkLog(u)),e},isYdodActive:function(t){var n="yoda_"+t,r;return NeoGV.isYdod?(e.fire("util:ymstats",{name:"ydodBlock",tags:{api:n,mode:"active"},include:{farm:!0}}),r=e.mail.Errormap.getErrorInfo({code:"999",suppressNotification:!1,suppressStat:!0}),e.mail.Error.showTae(r),!0):!1},preCheckProceed:function(e,t){return!o.isYdodActive(t)},stat:function(t){e.fire("util:ymstats",{name:s+"_"+t})},statTime:function(t,n,r){e.fire("stat:feature_latency",{feature_group:s+"_"+t,message:n,value:r})},splunkLog:function(t,n){n||(n=NeoConfig.isCorpmail?"critical":"info"),e.fire("SplunkLog","debug_v3cntr",t,n)},getMessageCountBucket:function(e){var t=0;return e<51?t=50:e<101?t=100:e<201?t=200:e<501?t=500:e<1001?t=1e3:e<5001?t=5e3:e<10001?t=1e4:t=10001,t},getBlockedImageSetting:function(t,r){var i=e.common.persist.UserData.get("userUIPref.imageBlocking"),s,o;if(n.isDraftFid(t))return"none";switch(i){case"0":o="none";break;default:o="all"}return strings.str_cfg_tog_old_imageblock?i==="b"&&(o=t==="%40B%40Bulk"?"all":"none"):(n.isSpamFid(t)&&(o="all"),i==="b"&&r&&(s=r.flags)&&s.inAddressBook&&(o="none")),o},translateMid:function(e,t){t.forEach(function(t){var n=t.replace(/_/g,"/").replace(/-/g,"+");e.mid.indexOf(n)>=0&&(e.mid=t)})},processBody:function(t){return e.mail.Controller.Messages._process(t,{fid:t.sourceFolderInfo.fid,key:t.mid,msg:t}),t},store:{cacheGDM:function(e,t){var n=e.message[0];t&&o.translateMid(n,t),r.set(n.sourceFolderInfo.fid,n,"add",!0,o.processBody)},getMessage:function(e,t){var n=r.get(e,t);return n?n:!1}}},e.namespace("mail.controller.v3").helper=o},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore","mail-controller-imapin","mail-ui-folder-utils","common-persist-user-data","array-extras","mail-errormap","mail-error"]});
YUI.add("mail-controller-v3-converter",function(e){function u(e){return e.type==="image"}function a(e,t){var n,r,i,s,o;if(e===null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof t!="function")throw new TypeError("predicate must be a function");n=Object(e),i=n.length>>>0,s=arguments[1];for(r=0;r<i;r++){o=n[r];if(t.call(s,o,r,n))return o}return undefined}function f(e){return{email:e.email||"",name:e.name||e.email||""}}function l(e){var t=[],n,r;for(n=0;n<e.msgs.length;n++)r=e.msgs[n],t.push({mid:r.mid,fid:r.fid});return t}function c(e){var t,n=[],i=[],s,o;for(t=0;t<e.length;t++){if(r.isDraftFid(e[t].sourceFolderInfo.fid)){n.push(e[t]);continue}s=0,o=n.length;while(o>0&&s<o)e[t].mimeMsgId===n[s].inReplyTo?(n[s].oMsgMid=e[t].mid,i.push(n.splice(s,1)[0]),o--):s++;i.push(e[t])}s=0,o=n.length;while(o>0)i.push(n.splice(0,1)[0]),o--;return i}function h(e,t){var n=e.messages[e.messageIds[e.messageIds.length-1]],r=[],i=0,s=!1,o=!1,l=!1,c=[],h={},p,d=0,v={folderInfo:{fid:t,name:""},isSystem:!1},m=[],g=0,y,b=function(e){return e.name===w.headers.from[0].name},w;for(y in e.messages)w=e.messages[y],p=w.folder.oldV2Fid,h[p]||(h[p]={total:0,unread:0}),p===t&&(v.folderInfo.name=w.folder.name,v.isSystem=w.folder.types.indexOf("USER")<0,i=Math.max(i,w.headers.internalDate*1||0)),d+=w.size,h[p].total=h[p].total+1,h[p].unread=h[p].unread+(w.flags.read?0:1),w.headers.from&&!a(r,b)&&(r=r.concat(w.headers.from.map(f))),s=s||!!w.attachments||w.attachmentCount>0,w.attachments&&(l=l||a(w.attachments,u)),o=o||w.folder.types.indexOf("DRAFT")>=0,g+=w.flags.flagged?1:0,m.push({mid:w.id,flags:{isReplied:w.flags.answered?1:0,isFlagged:w.flags.flagged?1:0,isRead:w.flags.read?1:0,isDraft:o,isForwarded:w.flags.forwarded?1:0,isHam:w.flags.ham?1:0,isSpam:w.flags.spam?1:0,inAddressBook:w.flags.addressBook?1:0,hasAttachment:s?1:0,hasImage:l,isRecent:w.flags.recent?1:0},header:{from:f(w.headers.from[0]),to:w.headers.to,subject:w.headers.subject,snippet:w.snippet,externalPopServer:null,receivedDate:w.headers.date*1||0,size:w.size},from:f(w.headers.from[0]),toEmail:w.headers.sender,inReplyTo:w.headers.inReplyTo,subject:w.headers.subject,snippet:w.snippet,mimeMsgId:w.id,receivedDate:w.headers.date*1||0,size:w.size,sourceFolderInfo:{fid:w.folder.oldV2Fid,name:w.folder.name},cid:w.conversationId});for(p in h)c.push({fid:p,total:h.total,unread:h.unread});return{summary:{subject:n.headers.subject,totalMsgs:e.total,unreadMsgs:e.unread,totalSize:d,checksum:e.id,iDate:i,hasAttachment:s,hasDraft:o,flaggedMsgs:g,participantList:r,msgCountsByFolder:c},messageInfo:m,folderSummary:v}}function p(e,t){var n=h(e,t);return{conversation:{cid:e.id,summary:n.summary,messageInfo:n.messageInfo},folderSummary:n.folderSummary}}function d(e){var t=!!e.attachments||e.attachmentCount>0,n=!1,r=!1,i=!1;return t&&(i=!!a(e.attachments,u)),n=e.folder.types.indexOf("DRAFT")>=0,r=e.folder.types.indexOf("USER")<0,{flags:{isReplied:e.flags.answered?1:0,isFlagged:e.flags.flagged?1:0,isRead:e.flags.read?1:0,isDraft:n,isForwarded:e.flags.forwarded?1:0,isHam:e.flags.ham?1:0,isSpam:e.flags.spam?1:0,inAddressBook:e.flags.addressBook?1:0,hasAttachment:t?1:0,hasImage:i,isRecent:e.flags.recent?1:0},from:f(e.headers.from[0]),fromFBUser:null,searchinfo:null,inboxservices:[],header:{from:f(e.headers.from[0]),to:e.headers.to,subject:e.headers.subject,snippet:e.snippet,externalPopServer:null,receivedDate:e.headers.date*1||0,size:e.size},folderInfo:{fid:e.folder.oldV2Fid,name:e.folder.name,isSystem:r,index:e.folder.id},sourceFolderInfo:{fid:e.folder.oldV2Fid,name:e.folder.name,index:e.folder.id},uid:e.id,uidl:e.id,errorflag:null,retriable:null,mid:e.id,cid:e.conversationId,toEmail:e.headers.to&&(e.headers.to[0].name||e.headers.to[0].email),toEmailDir:"auto",subject:e.headers.subject,snippet:e.snippet,snippetDir:"auto",subjectDir:"auto",mimeType:"multipart/mixed",xapparentlyto:null,mimeMsgId:null,inReplyTo:e.headers.inReplyTo,externalPopServer:null,receivedDate:e.headers.date*1||0,size:e.size,classification:e.classification,FilterResultBean:e.filterResult,msgSnippet:e.snippet}}function v(e){var t=e.conversations.length,n=[],r,i,s=0,u,a,f=e.folder;if(f.total&&!t&&f.folderInfo.fid!=="%40B%40Bulk"){e.code="ResponseCountMismatch";return}for(i=0;i<t;i++)u=e.conversations[i].conversation.messageInfo[0].receivedDate,u>s&&(s=u);a=(new Date).getTime();for(i=0;i<t;i++)r=o.toConvInfo(e.folder.folderInfo.fid,e.conversations[i]),r.snapshotTime=s,r.reqTime=a,n.push(r);e.convInfo=n}function m(e,t,n){var r=0,i=e.length,s,o=[],u={folderInfo:{fid:t,name:""},total:0,unread:0,size:0,isSystem:!1,totalConversations:i};n=n||{count:1,start:-1},n.start>=0&&i<n.count?u.totalConversations=i:n.start>=0&&(u.totalConversations=n.start+i+10);for(r=0;r<i;r++)s=p(e[r],t),u.folderInfo.name=s.folderSummary.folderInfo.name,u.total=u.total+s.conversation.summary.totalMsgs,u.unread=u.unread+s.conversation.summary.unreadMsgs,u.size=u.size+s.conversation.summary.totalSize,u.isSystem=s.folderSummary.isSystem,o.push({conversation:s.conversation});return{conversations:o,folder:u}}function g(e,t,n){var r=e.length,s=i.get(t),o,u,a=[],f={folderInfo:s.folderInfo,unread:s.unread,total:s.total,size:0,isSystem:!1,softDeleted:0,unreadSoftDeleted:0};for(o=0;o<r;o++)u=d(e[o]),f.size=f.size+u.size,f.isSystem=u.folderInfo.isSystem,a.push(u);return{messageInfo:a,folder:f,startMid:0,numMid:0,startInfo:n,numInfo:e.length}}function y(e,t){var n,i,u,a,f=t.originalLen;for(n=0;n<e.msgs.length;n++){e.msgs[n].header||(e.msgs[n]=s.toMessage(t.sourceFid,e.msgs[n]));if(r.isDraftFid(e.msgs[n].fid)&&t&&t.newMsg){u=t.oldMsgCnt||0;for(i=0;i<e.msgs.length;i++)if(e.msgs[i].mid===t.newMsg.mid){a=e.msgs[i];break}a&&a.inReplyTo===e.msgs[n].inReplyTo&&e.msgs.length-1>u&&(e.msgs.splice(n,1),e.midMap.splice(n,1))}}return f!==e.msgs.length&&(e=o.calcConvSummary(e)),e.msgs=c(e.msgs),e.msgs.reverse(),e.midMap=l(e),e}var t,n=e.mail,r=e.mail.ui.FolderUtils,i=n.model.DataStore.Folders,s=n.model.DataStore.Messages,o=n.model.ConvStore
.Conversations;t={listMessages:g,listMessageThreads:m,generateConvInfo:v,getConvPaneContent:y},e.namespace("mail.controller.v3").converter=t},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore"]});
YUI.add("mail-api-folder-selector",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.BaseSelector;t=function(e){function o(e,t){s[e]=t}var r=this,i,s;e=e||{},i=e.mailboxId||NeoConfig.V3MailboxId,s={},n(r,{typeName:"folders",id:function(e){return o("id",e),r},serialize:function(){var e="/ws/v3/mailboxes/@.id=="+r._urlEscape(i)+"/folders";return s.id&&(e=e+"/@.id=="+r._urlEscape(s.id)),e}}),t.superclass.constructor.call(this,e)},e.extend(t,r),e.namespace("Mail.Api").FolderSelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-controller-v3",function(e){function y(){}function b(e,t,n){var r=n==="messages"?t.messages:t.conversations,i=n==="messages"?c:h,o=n==="messages"?"flag":"conv_flag",u=t.flags,a={},f;for(f in u)f==="read"&&(a[d.FLAGS[f]]=u[f]?0:1);typeof u.read!="undefined"&&(i.update(t.sourceFid,r,{flags:a},o),s.triggerCheckMail(0))}function w(){var e=s.yTimerObj;e&&e.cancel&&e.cancel()}function E(e,t){var n=[],r,i;if(e.length>m){for(r=0,i=e.length;r<i;r+=m)n.push(e.slice(r,r+m));n.forEach(function(e){t(e)})}else t(e)}function S(e,t){var n=t.method,r=e.messages,i=d.pluck(r,"mid"),s=e.sourceFid,o=e.destinationFid,u,a;switch(n){case"update":t.optimisticRemove||c.remove(s,r,!o,o,{}),c.move(s,o,i,i,"move",{});break;case"remove":c.remove(s,r,!o,o,{})}u=p.get(s),u&&p.set(u,"ds:msg:",1),a=o&&p.get(o),a&&(d.updateUnreadCountForDestOnMove(a,r),p.set(a,"ds:msg:",1))}function x(e,t){var n=t.method,r=e.conversations,i=d.pluck(r,"cid"),s=e.sourceFid,o=e.destinationFid;switch(n){case"update":t.optimisticRemove||h.remove(s,r,o),h.move(s,o,i,null,"move");break;case"remove":h.remove(s,r,o)}}function T(e,t,n){var r=t.entity,i=t.method,o=0,u="update_"+t.actionTitle+"_"+(n.isBulkOperation?"async":"sync"),a=Date.now();return n.isBulkOperation&&n.progress&&(w(),e.onChange(function(e){var t=e[r][i],s=t.length,u=0;t.forEach(function(e){u+=e.progress}),u/=s,u>o?o=u:u=o,n.progress({processed:u,total:100})})),e.sync().then(function(e){var o=e[r][i][0]||{},f=Date.now()-a;o.success?(t.updateStore&&(r==="conversations"?x(n,t):S(n,t)),d.statTime(u,"success",f),n.success&&n.success(o.progress)):(t.actionTitle==="flag"?b(e,n,r):i==="update"&&!n.isBulkOperation&&s.triggerCheckMail(0),n.failure&&n.failure()),n.isBulkOperation&&s.triggerCheckMail(0)}),{abort:function(){return e.cancelSync()}}}function N(t){var n="flag",i=new r({showTAE:t.showTAE,statTAE:t.statTAE,actionTitle:n}),s=o.getCurrentAccount().id,a=e.mail.ui.FolderUtils,l=t.flags,h=d.getFlagStatusForDS(l),p=l.notmymail||l.phished||l.sendercompromised,v=l.ham||l.spam,m={entity:"messages",method:"update",actionTitle:n,updateStore:v||p,optimisticRemove:!1},g;t.notifyStoreMsgByMsg?t.messages=d.dedupe(t.messages,"mid",function(e){c.update(e.fid,[e]||[],{flags:h},"flag")}):c.update(t.sourceFid,t.messages||[],{flags:h},"flag"),g=d.pluck(t.messages,"mid");if(g.length<=0)return;return E(g,function(e){var n=new u({isBulkOperation:t.isBulkOperation||!1}),r=new f({messageSelector:n,accountId:s});n.id(e),r=d.setFlagInUpdater(l,r),i.messages.update(r)}),p&&(t.destinationFid=a.getSpamFid(s)),T(i,m,t)}function C(e){var t="move",n=new r({actionTitle:t}),s=o.getCurrentAccount().id,a=d.pluck(e.messages,"mid"),l=e.destinationFid,h=p.get(l),v={entity:"messages",method:"update",actionTitle:t,updateStore:!0,optimisticRemove:!1},m;if(a.length<=0)return;return m=d.setSpamHamForMove(null,e.sourceFid,e.destinationFid),i.isEmpty(m)||c.update(e.sourceFid,e.messages||[],{flags:m},"flag"),e.messages.length<=g&&(v.optimisticRemove=!0,c.remove(e.sourceFid,e.messages,!l,l,{})),E(a,function(t){var r=new u({isBulkOperation:e.isBulkOperation||!1}),i=new f({messageSelector:r,accountId:s});r.id(t),i.move(h.id),d.setSpamHamForMove(i,e.sourceFid,e.destinationFid),n.messages.update(i)}),T(n,v,e)}function k(e){var t="remove",n=new r({showTAE:e.showTAE,statTAE:e.statTAE,actionTitle:t}),i=o.getCurrentAccount().id,s=e.sourceFid,a=o.getMsgPermDeleteFolders(i).indexOf(s)>-1?!0:!1,f=d.pluck(e.messages,"mid"),l={entity:"messages",method:"remove",actionTitle:t,updateStore:!0,optimisticRemove:!1};if(f.length<=0)return;return!a&&e.destinationFid?C(e):(E(f,function(t){var r=new u({isBulkOperation:e.isBulkOperation||!1});r.id(t),n.messages.remove(r)}),T(n,l,e))}function L(t){var n="flag",i=new r({showTAE:t.showTAE,statTAE:t.statTAE,actionTitle:n}),s=o.getCurrentAccount().id,a=d.pluck(t.conversations,"cid"),l=e.mail.ui.FolderUtils,c=t.flags,p=c.notmymail||c.phished||c.sendercompromised,v=c.ham||c.spam,m={entity:"conversations",method:"update",actionTitle:n,updateStore:v||p,optimisticRemove:!1};if(a.length<=0)return;return h.update(t.sourceFid,t.conversations||[],{flags:d.getFlagStatusForDS(c)},"conv_flag"),p&&(t.destinationFid=l.getSpamFid(s)),E(a,function(e){var n=new u({isBulkOperation:t.isBulkOperation||!1}),r=new f({messageSelector:n,accountId:s});n.conversationId(e),n.acctId(s),d.setFolderSelection(n,t.sourceFid,"flag"),d.setFlagInUpdater(c,r),i.conversations.update(r)}),T(i,m,t)}function A(e){var t="move",n=new r({actionTitle:t}),s=o.getCurrentAccount().id,a=d.pluck(e.conversations,"cid"),l=p.get(e.destinationFid),c={entity:"conversations",method:"update",actionTitle:t,updateStore:!0,optimisticRemove:!1},v;if(a.length<=0)return;if(!d.isDestinationForMoveValid(e.sourceFid,e.destinationFid))return;return v=d.setSpamHamForMove(null,e.sourceFid,e.destinationFid),i.isEmpty(v)||h.update(e.sourceFid,e.conversations||[],{flags:v},"conv_flag"),e.conversations.length<=g&&(c.optimisticRemove=!0,h.remove(e.sourceFid,e.conversations,e.destinationFid)),E(a,function(t){var r=new u({isBulkOperation:e.isBulkOperation||!1}),i=new f({messageSelector:r,accountId:s});r.conversationId(t),r.acctId(s),d.setFolderSelection(r,e.sourceFid,"move"),i.move(l.id),d.setSpamHamForMove(i,e.sourceFid,e.destinationFid),n.conversations.update(i)}),T(n,c,e)}function O(e){var t="remove",n=new r({actionTitle:t}),i=o.getCurrentAccount().id,s=e.sourceFid,a=o.getMsgPermDeleteFolders(i).indexOf(s)>-1?!0:!1,f=d.pluck(e.conversations,"cid"),l={entity:"conversations",method:"remove",actionTitle:t,updateStore:!0,optimisticRemove:!1};if(f.length<=0)return;return!a&&e.destinationFid?A(e):(E(f,function(t){var r=new u({isBulkOperation:e.isBulkOperation||!1});r.conversationId(t),r.acctId(i),d.setFolderSelection(r,e.sourceFid,"delete"),n.conversations.remove(r)}),T(n,l,e))}function M(t){var n=t.action+"_folder",a=new r({actionTitle:n}),l=new u({isBulkOperation:t.isBulkOperation}),c=o.getCurrentAccount().id,h=t.sourceFid,p=e.mail.ui.FolderUtils,v=o.getMsgPermDeleteFolders
(c).indexOf(h)>-1?!0:!1,m=new f({messageSelector:l,accountId:c}),g=i.settings.value("folderAPIV3LimitCount"),y=p.getFolderByName(t.sourceFid).id,b,E,S;l.folderId(y),l.page.count(g);switch(t.action){case"emptyFolder":E=o.getFolderByType("TRASH",c)||"",v?(m=l,S="remove"):(m.move(E.id),S="update");break;case"markReadFolder":l.isUnread(),m.read(),S="update";break;case"archiveFolder":E=o.getFolderByType("ARCHIVE",c)||"",m.move(E.id),S="update"}return d.stat(n+"_invoked"),t.isBulkOperation&&t.progress&&(w(),a.onChange(function(e){t.progress(e.messages[S][0].progress)})),a.messages[S](m),b=Date.now(),a.sync().then(function(e){var r=e.messages[S]&&e.messages[S][0]||{},i=Date.now()-b,o,u;t.success(r.progress),!r.success&&r.status==="PARTIAL_SUCCESS"?u="partial":r.success?u="success":u="failed",d.stat(n+"_"+u),d.statTime(n,u,i),o={name:"folderOperation",type:t.action,messageBucket:d.getMessageCountBucket(t.totalMsgs),status:u,latency:i},d.splunkLog(o),t.isBulkOperation&&s.triggerCheckMail(0)}),{abort:function(){return d.stat(n+"_abort"),a.cancelSync()}}}function _(e){var t=new u,n=[],i={hasAttachment:"attachment",unRead:"unread",flagged:"flagged"},s=e.entity,o=new r({actionTitle:"get-"+s+"-list"});return t.folderId(d.getFolderId(e.fid)),s==="conversations"&&t.groupByConversation(),e.start&&t.page.offset(e.start),e.count&&t.page.count(e.count),e.sortKey&&e.sortOrder&&(e.groupBy?i[e.groupBy]&&n.push(i[e.groupBy]):(e.sortOrder==="down"&&e.sortKey==="date"&&n.push("-"),n.push(e.sortKey)),t.page.sortBy(n.join(""))),o[s].get(t),o}function D(e){var t;return e.entity="conversations",t=_(e),v(t).then(function(t){var n=t.conversations.get[0],r=(new Date).getTime(),i;if(!n.success)return e.failure();i=a.listMessageThreads(n.result,e.fid,{count:e.count,start:e.start}),a.generateConvInfo(i),i.conversations.forEach(function(e){var t=e.conversation;h.set({conversation:{cid:t.cid,summary:t.summary},folder:i.folder,messageInfo:t.messageInfo},r)}),e.success(i)}),{abort:function(){t.cancelSync()}}}function P(e){var t;return e.entity="messages",t=_(e),v(t).then(function(t){var n=t.messages.get[0],r;if(!n.success)return e.failure();r=a.listMessages(n.result,e.fid,e.start),e.success(r)}),{abort:function(){t.cancelSync()}}}function H(t){var n=new r({actionTitle:"getConversation",showTAE:t.showTAE}),i,s,o="get",f=1,c=!!t.conversationId,p=!c&&t.messageId,v=c?t.conversationId:"$(conversationId)",m={sourceFid:t.cfid,newMsg:t.newMsg,originalLen:t.originalLen||0,oldMsgCnt:t.originalLen||0},g={typeName:"messages",serialize:function(){return{iterator:"$..messages[0]",select:{conversationId:"$.conversationId"}}}},y={typeName:"conversations",serialize:function(){return{iterator:"$..messages[?(!@.headers.inReplyTo || !@.flags.read || 'INBOX' in @.folder.types || 'SENT' in @.folder.types)]",select:{mid:"$.id"}}}},b=new u,w=new u;if(c&&h.isCached(t.cfid,v))return i=h.get(t.cfid,v,!0),s=a.getConvPaneContent(i,m),e.mail.controller.v3.api.getSimpleBodyofMessages({messageList:[s.msgs[0]],sourceFid:t.cfid,success:function(e){e.length>=1?(s.fullmsg=e[0],t.success(s)):typeof t.failure=="function"&&t.failure(s)}});w.conversationId([v]),w.page.count(f),w.groupByConversation(),p&&b.id([t.messageId]);if(!c&&!t.messageId)throw new Error("Either conversationId or messageId is required for getConversation call");return c||n.messages.pipe(b,g),t.getDisplay?(o="pipe",n.conversations.pipe(w,y).display.get((new l({messageId:"$(mid)"})).tag("$(mid)").blockImages(d.getBlockedImageSetting(t.cfid))).closePipe()):n.conversations.get(w),c||n.closePipe(),n.sync().then(function(e){var n=e.conversations[o][0],r,u=(new Date).getTime(),l;if(!n.success)return t.failure();l=a.listMessageThreads(n.result,t.cfid,{start:-1,countQueried:f}),a.generateConvInfo(l),l.conversations.forEach(function(e){var t=e.conversation;c||(v=t.cid),h.set({conversation:{cid:t.cid,summary:t.summary},folder:l.folder,messageInfo:t.messageInfo},u)}),i=h.get(t.cfid,v,!0);if(!i){typeof t.failure=="function"&&t.failure(s);return}t.getDisplay&&e.display.get[0].success&&(r=e.display.get[0].result,r.forEach(function(e){d.store.cacheGDM(e,n.result[0].messageIds)}),d.translateMid(r[0].message[0],n.result[0].messageIds),i.fullmsg=d.processBody(r[0].message[0])),s=a.getConvPaneContent(i,m),t.success(s)}),[{abort:function(){n.cancelSync()}}]}function B(e){var t=new r({statTAE:e.statTAE,showTAE:e.showTAE,actionTitle:"getMessage"}),n=!0,i=e.sourceFid,s=e.filter||{},o=d.pluck(e.messageList,"mid"),u=[],a=[],f=!1,c=e.success||function(){},h=function(){c(u,a,f)};return e.useCache===!1&&(n=!1),e.messageList.forEach(function(r){var o=d.store.getMessage(i,r.mid),a=o&&o.body,f=o.isTruncated,c=s.truncateAt===null,h=o.hasBlockedImages,p=s.midRequest&&s.midRequest.blockImages==="none"||e.blockImages==="none",v=!c||!f,m=!p||!h,g=a&&v&&m,y=n&&g,b;y?u.push(o):(b=new l({messageId:r.mid}),b.blockImages(e.blockImages?e.blockImages:d.getBlockedImageSetting(i,r)),b.setFid(i).setFilter(s),t.display.get(b))}),t.hasItemToSync()?(t.sync().then(function(t){t.display.get.forEach(function(t,n){t.success?(d.translateMid(t.result[0].message[0],o),u.push(d.processBody(t.result[0].message[0])),d.store.cacheGDM(t.result[0],o)):a.push({mid:e[n]}),f=f||!!t.abort}),h()}),[{abort:function(){t.cancelSync()}}]):[d.nextTick(function(){h()},function(){f=!0,h()})]}function j(e,t){return function(n){return d.preCheckProceed(n,t)?e.call(null,n):(setTimeout(function(){n.failure&&n.failure()},0),null)}}var t=e.mail,n=e.Mail,r=n.Api.Yoda,i=e.common.Utils,s=t.Controller.Folders,o=t.Controller.ImapIn,u=n.Api.MessageSelector,a=t.controller.v3.converter,f=n.Api.MessageUpdater,l=n.Api.DisplaySelector,c=t.model.DataStore.Messages,h=t.model.ConvStore.Conversations,p=t.model.DataStore.Folders,d=t.controller.v3.helper,v=d.createYodaSyncDebouncer(100),m=3e3,g=200;y.prototype={flagMessagesWithMid:j(N,"flag"),moveMessagesWithMid:j(C,"move"),deleteMessagesWithMid:j(k,"remove"),flagConversationsWithCid:j(L,"flag"),moveConversationsWithCid:j(A,"move"),deleteConversationsWithCid
:j(O,"remove"),updateMessagesWithFid:j(M,"folder"),getConvList:j(D,"convlist"),getMsgList:j(P,"msglist"),getConversation:j(H,"getconv"),getSimpleBodyofMessages:j(B,"getmessage")},e.namespace("mail.controller.v3").api=new y},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore","mail-api-yoda","mail-api-message-selector","mail-api-display-selector","mail-api-message-updater","mail-controller-v3-helper","mail-controller-v3-converter","mail-api-folder-selector","mail-controller-folders","mail-controller-imapin","mail-ui-folder-utils","mail-common-utils-settings"]});
