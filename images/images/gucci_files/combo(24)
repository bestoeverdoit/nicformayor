YUI.add("common-ui-conv-listview-ext",function(e){var t=e.Node,n=e.one,r=e.Lang,i=e.Array,s=e.common.Utils,o=s.features,u=s.settings,a=e.Object,f=e.common.ui.TimeChunk,l=e.mail.model.DataStore.Folders,c="#",h="list",p="requestSize",d="pageSize",v="page",m="dash",g="pageCount",y="loading",b=".",w="fidchange",E="setrange",S="selected",x="remove",T="update",N="renderComplete",C="list-stat:scrolRenderComplete",k="KEY",L="SUBKEY",A="reverse",O="focused",M="tabIndex",_="height",D="prefetch",P="outofsync",H="append",B=n("body"),j=n("#main"),F,I,q,R;e.mix(e.common.ui.ConvListView.prototype,{_selectRange:function(t,n,r,i){var s=this,o=s._getIndexN,u,a,f,l,c;t._node&&(t=o(t)),r._node&&(r=o(r)),f=l=r;if(e.Lang.isNumber(r)){u=s._isSubindex(f),a=s._isSubindex(t);if(u!=a)return;if(u){if(s._getMainindex(f)!=s._getMainindex(t))return;t=s._getSubindex(t),f=s._getSubindex(f)}c=t<=f?-1:1;while(f!==t+c)s._selectByIndex(l,n,0,1,0,1),u?l[1]+=c:l+=c,f+=c}i||s.set("selectionCount",s.selCount())},_updateItem:function(r,i,s){var o=this,u="list-view-item-date-label",a="this-week",f="data-tc-label",l=i?o.stop()-1:r,h=o._model.valueAt(l),p=n(c+o._id(r)),d=p?o._getItemContainer(p):null,v=o.get("activeItem"),m,g,y,w,E,S,x,T,N,C,k,L,A,_,D;if(h&&p){S=v?o._getIndexN(v):-1,w=o._lastSel?o._getIndexN(o._lastSel):-1,E=o._lastSS?o._getIndexN(o._lastSS):-1,m=o.get(O)&&v,g=r==o._getMainindex(w),y=r==o._getMainindex(E),o.fire("beforeItemUpdate"),x=o._selectToRender(),NeoConfig.timeChunk&&o.listObj.timeChunk&&(L=p&&p.get("parentNode"),A=L&&L.previous(),_=NeoConfig.rearrangeMb&&A&&A.previous(),_&&_.hasClass(u)?(h.addDateLabel="",_.hasClass(a)&&(h.thisWeek=a,h.label=_.getAttribute(f))):A&&A.hasClass(u)?(h.addDateLabel="",A.hasClass(a)&&(h.thisWeek=a,h.label=A.getAttribute(f))):h.addDateLabel=""),h.msgs&&h.msgs[0]&&(h.snippet=h.msgs[0].snippet),k=t.create(o._renderItem(h,l,x[l],o._id(l),s));if(i){if(m||g)T=p.next(b+o.ITEM_CLASS_NAME)||k;d.remove(),k&&o._srcNode.append(k)}else d&&d.replace(k);o.fire("itemUpdate",{itemIndex:l,itemNode:k}),e.fire("listview:itemUpdate",k,h),m&&v!=null&&o._getMainindex(S)==r&&(T=n(c+o._id(S)),T&&o._focusItem(T)),g&&(N=n(c+o._id(w)),N&&(o._lastSel=N)),y&&(C=n(c+o._id(E)),C&&(o._lastSS=C)),r==o.start()&&!v&&(D=k?k.one(".list-view-item"):null,D&&(D.set(M,0),o._focusItem(D,1)))}},_handleFailure:function(e){var t=this;e.start!==0&&e.reason!=="prefetch"&&t.set("page",t.get("page")-1,{noupdate:1}),t.set("freeze",0)},_synclist:function(){var e=this;e._ss&&a.size(e._ss)&&(e._sel=e._model.indexesOf(e._ss)),e._sync(),e._lastSS=0,a.some(e._sel,function(t,n){return e._lastSel=e.getItemEl(n),1}),e._ss=0},_listchange:function(t){var n=this,r=n._sel,i={},o=n.checkmode,u,f,l,c,p,m,y,b,S=t.subtype||"DEFAULT";try{switch(t.subtype){case w:n.selCount()?(n._ss=a.values(r),n._synclist()):u=1;break;case E:n._synclist();break;case H:n._appendConversations(n.start(),n.stop());break;case D:break;case T:n._updateItem(t.index,!1,t.expand);break;case A:y=a.keys(r),p=y.length,l=n._model.get("length"),p===1?(m=y[0],b=m==l-m?m:l-m-1,n.set(v,Math.floor(b*1/n.get(d))),i[b]=r[y[0]]):n.set(v,0),n._clearSelect(1),n._sel=i,u=1,n.checkmode=o;break;case x:n._clearSelect(1),t.list&&t.list.length&&(f=n.getItemEl(t.list[0]))&&(n._set("activeItem",f),n._model.get(h).length===parseInt(t.list[0],10)?n._select(n.getItemEl(t.list[0]-1),1):n._select(f,1)),n.get("isActive")||n._set("activeItem",null),c=n.get(g),n.get(v)>=c&&n.set(v,c-1),u=1,n.setAttrs({focused:!0});break;case P:n._removeLoadingIndicator(),e.fire("util:ymstats",{name:"LFT_outofsync",include:{farm:!0}});break;default:u=1}u&&n._sync(!1,S)}catch(N){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:1",N,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:1"),s.error.report("ConvView-ListExt listchange error for subtype: "+t.subtype,N,1,1,1)}},_appendConversations:function(t,n){var r=this,i=r._model.get(h),s=0,o=r.get(d)*2,u=[],a=r._sel,l=r._srcNode,c=[],p=r.listObj?r.listObj.sortedColumn.sortOrder:"",v,m;if(q!==t||R!==n)r.setUpScrollSuccessRateStats(),q=t,R=n;if(r._r){r.fire("beforeRender"),r.fire("appendConversations"),r.set("showFocus",!1);for(m=t;m<n;m++){v=i[m];if(!v){s=1;break}c.push(i[m]),NeoConfig.timeChunk&&r.listObj.timeChunk&&(v.addDateLabel=f.addDateLabel(m,v,m>0?i[m-1]:"",p)),u.push(r._renderItem(v,m,a[m],r._id(m),!1))}s?(r._insertLoadingIndicator(),r._model.request(t,o,H)):l.all("."+r.PAGE_CLASS_NAME).size()*r.get(d)<t+1&&(r._removeLoadingIndicator(),l.appendChild('<div role = "presentation" id="'+e.guid()+'"class = "'+r.PAGE_CLASS_NAME+'">'+u.join("")+"</div>"),NeoConfig.timeChunk&&p==="down"&&f.addThisWeekLabel(),r.set("freeze",0),r.fire(N,{silent:!0}),r.fire(C))}},_insertLoadingIndicator:function(){var e=this,t=e._srcNode,n="listloading";t.one("#"+n)||t.appendChild("<div id="+n+' class="s-loader"></div>')},_removeLoadingIndicator:function(){var e=this,t=e._srcNode.one("#listloading");t&&t.remove().destroy(!0)},_renderVisiblePages:function(){var e=this,t=e._srcNode.get("scrollTop"),n=e.getCurrentPage(t),r,i=n-1<0?n:n-1;for(r=i;r<=n+1;r++)e.renderPage(r)},_sync:function(t,i){function a(){var r=this,u=r._model.get(h),a=0,l=r.stop(),c=t,v=r._srcNode,m=r._statusNode,g=r._maxLength,y=r._sel,w=r.get("activeItem"),E=r.get(d),x=e.Object.getValue(r,["listObj","fid"]),T=v.one("."+r.PAGE_CLASS_NAME),C=r.listObj?r.listObj.sortedColumn.sortOrder:"",k=r.get("page"),L=[],A=[],M=0,D,P,H,F,I,q,R,U,z,W,X;T&&(H=parseInt(T.getComputedStyle("height"),10)),I=r.getCurrentPage();if(r._r){r.fire("beforeRender"),r.set("showFocus",!1);for(z=a;z<l;z++){W=u[z];if(!W){c=1,M=z;break}A.push(u[z]),z%E===0&&(F=z/E,z!==0&&L.push("</div>"),!H||F>=I-1&&F<=I+1||F===k?L.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'">'):L.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'" style="height:'+H+'px">'));if(F>=I-1&&F<=I+1||F===k)z%E===0,NeoConfig.timeChunk&&r.
listObj.timeChunk&&(W.addDateLabel=f.addDateLabel(z,W,z>0?u[z-1]:"",C)),L.push(r._renderItem(W,z,y[z],r._id(z),!1))}L.length&&L.push("</div>"),c?l-M<200?(P=t?r.get(d)*2:r.get(d),q=Math.max(l-M,P)||r.get(p),r._model.request(M,q,i)):r.refresh(1):(m&&m.addClass("hidden"),o.enabled("predictiveSearch")?(R=e.Node.create(L.join("")||"<div></div>"),R&&r.smwNode&&(U=r.smwNode.one(".search-my-world"),x==="Inbox"&&U?(R.insert(r.smwNode,0),B.addClass("no-mb")):NeoConfig.moneyballEnabled&&B.removeClass("no-mb")),s.remove(v.get("children")),v.insert(R)):(s.remove(v.get("children")),v.setHTML(L.join(""))),r._logCachedListLatency(i,x),NeoConfig.timeChunk&&C==="down"&&(n(".list-view-items").removeClass("etw").setAttribute("data-tc-label",""),f.addThisWeekLabel()),v.setStyle(_,"auto"),A.length&&(X=B&&B.hasClass("notoolbar")||j&&j.hasClass("withouttoolbar"),X||(i==="liststore"?e.fire("mbEvent:re-render"):(e.fire("mbEvent:rotate"),e.fire("rotateD2S")))),r.set("freeze",0)),r._maxLength=Math.max(g,v.get("offsetHeight")),t?r.set("activeItem",null):(D=r._parentNode,w=D.one(b+r.ITEM_CLASS_NAME+b+S),w||(i==="remove"?(A=D.all(b+r.ITEM_CLASS_NAME),w=A.item(A.size()-1)):w=D.one(b+r.ITEM_CLASS_NAME)),w&&(r.set("activeItem",w),r.get(O)&&r._focusItem(w),r._lastSel=w)),i!=="liststore"&&e.fire("mohawk:ready");if(!c){if(this.selCount()){if(r._lastSel)z=r._getIndexN(r._lastSel);else for(z in y)break;r._lastSS=r._lastSel=r.getItemEl(z)}i!=="liststore"&&r._prefetch(i),e.fire("listview:sync",i),r.fire(N)}o.enabled("timeChunk")&&r.updateAnchoredLabel(!0,!1,i,x)}}var u=this;u.tmSync&&u.tmSync.cancel(),u._tmSync=r.later(0,u,a)},_logCachedListLatency:function(t,n){if(s.features.enabled("LFTCache")){var r=l.get(n);e.fire("MailLog",{m:"list is re-rendered because of "+t}),t==="liststore"?(I=Date.now(),F={bunread:r.unread,btotal:r.total}):I&&(F.aunread=r.unread,F.atotal=r.total,e.fire("SplunkLog","debug_lftcache",{t:Date.now()-I,r:t,f:F},NeoConfig.isCorpmail?"critical":"sample"),I=null,F=null)}},_resetScrollTop:function(){var e=this._parentNode.one(b+this.LIST_CLASS_NAME);e.set("scrollTop",0)},_setStatus:function(t){var n=this,r,i=!1,s="";r=n._statusNode,t=t||"",i=t.hideLoader||!1,s=t.tmpl||t,!r&&n._parentNode&&(r=e.Node.create('<div role="'+n.STATUS_ROLE+'" tabindex="-1" class="status '+n.STATUS_CLASS_NAME+'"></div>'),r.addClass("hidden"),n._statusNode=r,n._parentNode.one("#lv-statuses-container").prepend(r),n._maxLength=Math.max(500,n._srcNode.get("offsetHeight"))),r&&(i?r.removeClass(y):r.addClass(y),s==="loading-icon"&&(s='<div class="s-loader"></div>'),n._status=s||"",s&&n.get("focused")&&r.focus(),r.setContent(n._status),r.removeClass("hidden"),n._srcNode.setContent(""),n._srcNode.setStyle(_,n._maxLength+"px"))},_prefetch:function(e){var t=this,n=t._model.get(h),r=t.stop(),i=Math.min(n.length,r+t.get(d))-1;e==="remove"&&(i-=u.value("LFTDeleteBufferSize",0)),r<n.length&&!n[i]&&t._model.request(r,t.get(d)*2,D)},_setSelection:function(e){function u(){s=t._model.get(h),i.each(e,function(e){o[e]=s[e]||1,n=e}),t._sel=o}var t=this,n,s=t._model.get(h),o={};t._clearSelect(),e=e?r.isObject(e)?a.keys(e):r.isArray(e)?e:[e]:[],u(),n&&(s[n]||t.once(N,u,t),t.set("page",Math.floor(n/t.get(d)),{noupdate:1})),t._sync()},_blur:function(){return},_moveToItem:function(e,t){var n=this,r=!0,i={188:1,190:1},s;if(e){n._focusItem(e);if(!t.metaKey&&!t.ctrlKey||t.ctrlKey&&!t.keycodeOverride&&i[t.keyCode]){t.shiftKey&&n._lastSel?n._select(n._lastSel,0,e,1,0,!0):n._clearSelect(),n._lastSel=e,n._select(e,1,n._lastSS,t.shiftKey);if(n.selCount()==1||!t.shiftKey)n._lastSS=e;r=!1}t.subselect&&(s=this._getSubindex(n._getIndexN(e)))>=0&&(n._subselIndex=s,n.fire("subselect"),n._subselIndex=-1),n.set("showFocus",r)}t.halt&&t.halt()},_expandItem:function(e,t,n){var r,i,s=this,o=s._model;o.expanding||(o.expanding=!0,(r=s._getSubitemContainer(n))?(s._showSubitems(r,e),o.expanding=!1):o.getSubitem(e,0)?(o.update(t,e,!0),n=s.getItemEl(t),i=s._getItemContainer(n),i.removeClass("expanded"),o.expanding=!1,s._expandItem(e,t,n)):o.requestSub(e,t),s.set("activeItem",n),s.set("showFocus",null),s.fire("expand"))},_getNeighborItem:function(e,t){var n=this,r,i,s,o=n._getIndexN(e),u=b+n.ITEM_DETAIL_CLASS_NAME;if(n._isSubindex(o))i=e[t?"next":"previous"](u),i||(i=n._getMasterItem(e),t&&(i=n._getNeighborMasterItem(i,t)));else{if(t&&e.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(e)))if(i=n._getEndDetailItem(r,!0,!1))return i;i=n._getNeighborMasterItem(e,t);if(i&&!t&&i.ancestor(".list-view-item-container").hasClass("expanded")&&(r=n._getSubitemContainer(i)))if(s=n._getEndDetailItem(r,!1,!1))return s}return i},_resetSelection:function(e){var t=this,n,r,i,s,o=null,u=a.keys(t._sel);if(u)for(n=0;n<u.length;n++){r=t._toIndexN(u[n]);if(t._getMainindex(r)==e){i=t._getSubindex(r);if(i==-1){o=r;break}if(o==null||t._getSubindex(r)<t._getSubindex(o))o=r}}if(o!=null){t._clearSelect();if(s=t.getItemEl(o))t._set("activeItem",s),t._select(s,1);t.get("isActive")||t._set("activeItem",null)}},_disableMouseHover:function(){var t=this,n=e.one("#msg-list");if(!n)return;t.keyboardActiveEvent||(n.addClass("keyboard-active"),t.keyboardActiveEvent=n.on("mousemove",t._enableMouseHover,t))},_enableMouseHover:function(t){var n=this,r=e.one("#msg-list");n.clientX&&n.clientY?t.clientX!==n.clientX&&t.clientY!==n.clientY&&(r&&r.removeClass("keyboard-active"),n.keyboardActiveEvent.detach(),n.keyboardActiveEvent=null,n.clientX=null,n.clientY=null):(n.clientX=t.clientX,n.clientY=t.clientY)},_keydown:function(t){var r=this,i=r.get("activeItem"),s,o,u=b+r.ITEM_CLASS_NAME,a,f=r._getListItem(t,1),l,h,p,d,v,m,g,y=f?f.hasClass(S):0,w=0,E;r._disableMouseHover(),E=i?r._getIndexN(r.get("activeItem")):r._lastSel?r._getIndexN(r._lastSel):w,i||(i=r.getItemEl(E));if(!i||!r._srcNode.contains(i)){var x=Math.floor(E/r.get("pageSize"));r.renderPage(x,r._srcNode.all("."+r.PAGE_CLASS_NAME).item(x)),i=r.getItemEl(E)}r._set("activeItem",i);switch(t.keyCode){case 37:case 39:if(r.selCount()==1&&!r.get("previewPaneEnabled"
)){d=r._getIndexN(i),v=r.getItemEl(d),m=r._getItemContainer(v);if(m.hasClass("expanded")&&t.keyCode===37||!m.hasClass("expanded")&&t.keyCode===39){h=r._isSubindex(d),p=r._model.valueAt(d),l=r._model.isCollapsible(p),h&&(d=r._getMainindex(d));if(l||h)v=n(c+r._id(d)),r._expandItem(p,d,v),t.halt()}}break;case 38:case 40:case 188:case 190:e.fire("HoverCard:hideHoverCard"),t.altKey?(s=r.getItemEl(t.keyCode===38||t.keyCode===188?r.start():r.stop()-1),s&&(t.keyCode===40||t.keyCode===190)&&(o=r._getEndDetailItem(s,!1,!1))&&(s=o)):i&&(s=r.selCount()?r._getNeighborItem(i,t.keyCode===40||t.keyCode===190):i,s&&r._isSubindex(r._getIndexN(s))&&(g=t.ctrlKey,t.shiftKey=!1,t.ctrlKey=t.metaKey=!0,t.subselect=!g,!g&&r.selCount()==1&&r.get("selection")[0]!=r._getMainindex(r._getIndexN(s))&&(r._clearSelect(),r._select(r._getMasterItem(s),1))),!t.shiftKey&&!t.metaKey&&!t.ctrlKey&&r._lastSel&&r._lastSel.get("id")!==i.get("id")&&!r._isSubindex(r._getIndexN(i))&&(s=i)),s&&(!t.shiftKey&&!t.metaKey&&!t.ctrlKey&&r.selCount()&&r._clearSelect(),s=r.getItemEl(r._getIndexN(s)),r._moveToItem(s,t)),t.halt();break;case 32:if(t.metaKey||t.ctrlKey||t.altKey)return;f||(f=r.getItemEl(E),y=f?f.hasClass(S):0);if(r._isSubindex(r._getIndexN(f)))return;if(!r._checkbox(t)){if(r._isFormControl(t))return;t.shiftKey?r._selectRange(r._lastSS,!r._sel[r._getIndexN(i)],f):(y&&!r.checkmode?a=1:a=!y,r._select(f,a,0,1),r._lastSel=r._lastSS=a?f:0),t.halt()}break;case 13:r.selCount()==1&&(d=r._getIndexN(i),p=r._model.valueAt(d),h=r._isSubindex(d),l=r._model.isCollapsible(p),h||!l||!r.get("expandOnClick")?(r.fire("command",{e:t,index:h?r._getSubindex(d):r._getMainindex(d),subindex:h?r._getSubindex(d):-1,mainindex:r._getMainindex(d),item:p}),r.get("previewPaneEnabled")||t.halt()):(v=n(c+r._id(d)),r._expandItem(p,d,v),t.halt()));break;case 36:r.scrollToTop(),t.halt();break;case 33:if(t.ctrlKey)break;r.pageUpOrDown(!0),t.halt();break;case 34:if(t.ctrlKey)break;r.pageUpOrDown(!1),t.halt()}},_isCheckboxBorder:function(e){var t=e.target,n,r=0,i=0,s,o;if(t.hasClass("list-view-item"))return NeoConfig.hoverPreview||(o=t.one("div.info"),o&&(r=o.get("offsetWidth"))),s=t.one("input"),s&&(i=s.get("offsetWidth")),n=t.getX()||0,e.clientX>n&&e.clientX<n+i+r},getPageIndex:function(e){var t=this,n=t.get("page"),r=t.get("pageSize"),i=t._getListItem(e,1),s=t._getIndexN(i),o=s-n*r;return o},setUpScrollSuccessRateStats:function(){var t=this;t.scrolRenderCompleteHandler&&t.scrolRenderCompleteHandler.detach(),e.fire("stat:feature_invoke",{message:"UI_LIST_CONV_SCROLL_START_SUCCESS",feature_group:"LIST"}),t.scrolRenderCompleteHandler=t.once(C,function(){e.fire("stat:feature_complete",{message:"UI_LIST_CONV_SCROLL_COMPLETE_SUCCESS",feature_group:"LIST"})})}},1),e.mix(e.common.ui.ConvListModel.prototype,{setRange:function(e,t,n){var r=this,i=t.length,s=t||[],o=r.get(h),u=o.length;n=n||E,r._refresh&&(o=[],o.length=u,r._refresh=0);while(i--)o[e+i]=s[i];r.set(h,o,{subtype:n,start:e})},update:function(e,t,n){var r=this.get(h);try{r[e]=t,this.set(h,r,{subtype:T,index:e,expand:n})}catch(i){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-common-ui-listview-conv-listview-ext:2",i,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-common-ui-listview-conv-listview-ext:2"),s.error.report("ConvView-ListExt update error",i,1,1,1)}},remove:function(t){var n=this,s=r.isArray(t)?i(t).sort(i.numericSort):a.keys(t),o=s.length,u=n.get(h);s=i(s).sort(i.numericSort),e.fire(n.NAME+":remove",u,s);while(o--)u.splice(s[o],1);n.set(h,u,{subtype:x,list:s})},reverse:function(){var e=this,t=e.get(h);t.reverse(),e.set(h,t,{subtype:A})},indexesOf:function(e,t,n){var s,o,u=this,a,f,l,c,p=u.get(t?L:k),d=u.get(h),v={},g={},y=d.length;e=r.isArray(e)?e:[e],i.each(e,function(e){v[e[p]]=e});for(s=0;s<y;s++){a=d[s];if(t){l=u.getSubitemCount(a);for(o=0;o<l;o++)f=u.getSubitem(a,o),f&&v[f[p]]&&(c=s+m+o,g[s+m+o]=f)}else if(a=d[s]&&v[a[p]])g[s]=a}return n&&n(g),g}},1)},"1.0.0",{requires:["common-ui-conv-listview","common-ui-notification","mail-common-utils-features","mail-common-utils-settings","common-utils","mail-model-datastore"]});
